<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      æºç åˆ†æ weak å¯¹è±¡è‡ªåŠ¨ç½®ç©ºåŸç† &middot; Matt Reach
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <img src="/assets/images/icon_about.png"/>
    <p><p>æ»šæ»šä¸œé€æ°´ï¼Œæ·˜å°½è‹±é›„æ³ªã€‚</p><p>é’å±±ä¾æ—§åœ¨ï¼Œå‡ åº¦å¤•é˜³çº¢ã€‚ </p><p>å¤ä»Šå¤šå°‘äº‹ï¼Œéƒ½ä»˜ç¬‘è°ˆä¸­ã€‚</p></p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">é¦–é¡µ</a>
    <a class="sidebar-nav-item" href="/categories/">åˆ†ç±»</a>
    <a class="sidebar-nav-item" href="/qianfansdk">è½®å­</a>
    <a class="sidebar-nav-item" href="/about/">å…³äº</a>
  </nav>

</div>




    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Matt Reach</a>
            <small>an iOS Developer</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">

  <div class="post-header">
    <h1 class="post-title">æºç åˆ†æ weak å¯¹è±¡è‡ªåŠ¨ç½®ç©ºåŸç†</h1>
    <div class="post-date">
      <span class="post-meta">18 Jul 2017</span>
      
      	<span> Â· </span>
      	<a href="/categories/iOS/index.html">iOS</a>
    	
    	<span> Â· </span>
    	<span class="post-meta"> 34123 å­—</span>
    </div>
  </div>

  <div class="post-content">
    <blockquote>
  <p>æˆ‘ä»¬éƒ½çŸ¥é“ weak ä¿®é¥°çš„å˜é‡ï¼Œåœ¨å¯¹è±¡é‡Šæ”¾åï¼Œä¼šè‡ªåŠ¨ç½®ä¸º nilï¼Œè¿™ä¸€æœºåˆ¶å‡å°‘äº†å¤§é‡çš„é‡æŒ‡é’ˆå´©æºƒï¼›æˆ‘ä»¬è¿˜çŸ¥é“åœ¨ dealloc é‡Œä¸è¦ weak ä¿®é¥° self å¯¹è±¡ï¼Œå¦åˆ™å½“å¯¹è±¡ dealloc æ—¶å°±ä¼šå´©æºƒæ‰ï¼›ä¸€èµ·çœ‹ä¸‹æºç å®ç°å§!</p>
</blockquote>

<h2 id="ä¸‹è½½æºç ">ä¸‹è½½æºç </h2>

<p>è™½ç„¶ iOS ä¸æ˜¯å¼€æºçš„ï¼Œä½†æ˜¯ OBJC è¿™éƒ¨åˆ†ä»£ç æ˜¯ Opençš„ï¼Œä¸‹è½½åœ°å€ : <a href="https://opensource.apple.com/tarballs/objc4/">objc4-709.tar.gz</a> ã€‚è¿™æ˜¯ç¬¬äºŒæ¬¡é˜…è¯» objc æºç ï¼Œç¬¬ä¸€æ¬¡æ˜¯åˆ†æå…³è”å¼•ç”¨å®ç°åŸç†æ—¶é˜…è¯»çš„ : <a href="/ios/2016/03/06/Objc-Associations-Advanced.html#1">æ·±å…¥ç†è§£å…³è”å¼•ç”¨</a>;æˆ‘çŒœæµ‹ weak çš„å®ç°å’Œå…³è”å¯¹è±¡åº”è¯¥æ˜¯å¤§åŒå°å¼‚çš„ï¼Œæ€è·¯ä¸Šåº”è¯¥æ˜¯ç›¸åŒçš„ï¼Œåº”è¯¥ä¹Ÿæ˜¯åœ¨åˆ›å»ºåå­˜è¡¨ï¼Œdealloc æ—¶ç½®ç©ºï¼Œç„¶åä»è¡¨é‡Œç§»é™¤æ‰ã€‚</p>

<h2 id="æ³¨å†Œ-weak-å˜é‡">æ³¨å†Œ weak å˜é‡</h2>

<p>åˆå§‹åŒ–ä¸€ä¸ª weak æŒ‡é’ˆæ—¶ä¼šèµ° objc_initWeak å‡½æ•°:</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cm">/** 
 * Initialize a fresh weak pointer to some object location. 
 * It would be used for code like: 
 *
 * (The nil case) 
 * __weak id weakPtr;
 * (The non-nil case) 
 * NSObject *o = ...;
 * __weak id weakPtr = o;
 * 
 * This function IS NOT thread-safe with respect to concurrent 
 * modifications to the weak variable. (Concurrent weak clear is safe.)
 *
 * @param location Address of __weak ptr. 
 * @param newObj Object ptr. 
 */</span>
 
<span class="n">id</span> <span class="nf">objc_initWeak</span><span class="p">(</span><span class="n">id</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">id</span> <span class="n">newObj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">newObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">location</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">storeWeak</span><span class="o">&lt;</span><span class="n">DontHaveOld</span><span class="p">,</span> <span class="n">DoHaveNew</span><span class="p">,</span> <span class="n">DoCrashIfDeallocating</span><span class="o">&gt;</span>
        <span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="p">(</span><span class="n">objc_object</span><span class="o">*</span><span class="p">)</span><span class="n">newObj</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>å†…éƒ¨ä¼šèµ° objc_storeWeak æ–¹æ³•æ¥å­˜å‚¨ä½ å£°æ˜çš„ weak å˜é‡ :</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cm">/** 
 * This function stores a new value into a __weak variable. It would
 * be used anywhere a __weak variable is the target of an assignment.
 * 
 * @param location The address of the weak pointer itself
 * @param newObj The new object this weak ptr should now point to
 * 
 * @return newObj
 */</span>

<span class="n">id</span> <span class="nf">objc_storeWeak</span><span class="p">(</span><span class="n">id</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">id</span> <span class="n">newObj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">storeWeak</span><span class="o">&lt;</span><span class="n">DoHaveOld</span><span class="p">,</span> <span class="n">DoHaveNew</span><span class="p">,</span> <span class="n">DoCrashIfDeallocating</span><span class="o">&gt;</span>
        <span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="p">(</span><span class="n">objc_object</span> <span class="o">*</span><span class="p">)</span><span class="n">newObj</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>å†…éƒ¨åˆ™è°ƒç”¨äº† storeWeak è¿™ä¸ªå‡½æ•°ï¼Œå…¶å®è¿™ä¸ªæ³¨é‡Šå·²ç»è¯´çš„å¾ˆæ˜ç™½äº†ï¼Œ<strong>å¦‚æœ CrashIfDeallocating æ˜¯ true çš„è¯ï¼Œå½“ newObj æ­£åœ¨ dealloc æˆ–è€… newObj ä¸æ”¯æŒ weak å°±ä¼šå´©æºƒï¼</strong>è°ƒç”¨çš„æ—¶å€™ä¼ çš„æ˜¯æšä¸¾å€¼ DoCrashIfDeallocatingï¼Œæ­£æ˜¯ true ï¼æ‰€ä»¥ä¸Šä¸€ç¯‡åšå®¢é‡Œæåˆ°çš„åœ¨ dealloc é‡Œä½¿ç”¨ weak self ä¼šå´©æºƒï¼Œç«‹å³ <a href="/ios/2017/07/17/weakself-in-dealloc-cause-crash.html">ä¼ é€</a> ï¼</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="c1">// Update a weak variable.
// If HaveOld is true, the variable has an existing value 
//   that needs to be cleaned up. This value might be nil.
// If HaveNew is true, there is a new value that needs to be 
//   assigned into the variable. This value might be nil.
// If CrashIfDeallocating is true, the process is halted if newObj is 
//   deallocating or newObj's class does not support weak references. 
//   If CrashIfDeallocating is false, nil is stored instead.
</span><span class="k">enum</span> <span class="n">CrashIfDeallocating</span> <span class="p">{</span>
    <span class="n">DontCrashIfDeallocating</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">DoCrashIfDeallocating</span> <span class="o">=</span> <span class="nb">true</span>
<span class="p">};</span>
<span class="n">template</span> <span class="o">&lt;</span><span class="n">HaveOld</span> <span class="n">haveOld</span><span class="p">,</span> <span class="n">HaveNew</span> <span class="n">haveNew</span><span class="p">,</span>
          <span class="n">CrashIfDeallocating</span> <span class="n">crashIfDeallocating</span><span class="o">&gt;</span>
          
<span class="k">static</span> <span class="n">id</span> <span class="n">storeWeak</span><span class="p">(</span><span class="n">id</span> <span class="o">*</span><span class="n">location</span><span class="p">,</span> <span class="n">objc_object</span> <span class="o">*</span><span class="n">newObj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">haveOld</span>  <span class="o">||</span>  <span class="n">haveNew</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">haveNew</span><span class="p">)</span> <span class="n">assert</span><span class="p">(</span><span class="n">newObj</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">);</span>

    <span class="n">Class</span> <span class="n">previouslyInitializedClass</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="n">id</span> <span class="n">oldObj</span><span class="p">;</span>
    <span class="n">SideTable</span> <span class="o">*</span><span class="n">oldTable</span><span class="p">;</span>
    <span class="n">SideTable</span> <span class="o">*</span><span class="n">newTable</span><span class="p">;</span>

    <span class="c1">// Acquire locks for old and new values.
</span>    <span class="c1">// Order by lock address to prevent lock ordering problems. 
</span>    <span class="c1">// Retry if the old value changes underneath us.
</span> <span class="nl">retry:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">haveOld</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">oldObj</span> <span class="o">=</span> <span class="o">*</span><span class="n">location</span><span class="p">;</span>
        <span class="n">oldTable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SideTables</span><span class="p">()[</span><span class="nf">oldObj</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">oldTable</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">haveNew</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">newTable</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">SideTables</span><span class="p">()[</span><span class="nf">newObj</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">newTable</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">SideTable</span><span class="o">::</span><span class="n">lockTwo</span><span class="o">&lt;</span><span class="n">haveOld</span><span class="p">,</span> <span class="n">haveNew</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oldTable</span><span class="p">,</span> <span class="n">newTable</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">haveOld</span>  <span class="o">&amp;&amp;</span>  <span class="o">*</span><span class="n">location</span> <span class="o">!=</span> <span class="n">oldObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">SideTable</span><span class="o">::</span><span class="n">unlockTwo</span><span class="o">&lt;</span><span class="n">haveOld</span><span class="p">,</span> <span class="n">haveNew</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oldTable</span><span class="p">,</span> <span class="n">newTable</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Prevent a deadlock between the weak reference machinery
</span>    <span class="c1">// and the +initialize machinery by ensuring that no 
</span>    <span class="c1">// weakly-referenced object has an un-+initialized isa.
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">haveNew</span>  <span class="o">&amp;&amp;</span>  <span class="n">newObj</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Class</span> <span class="n">cls</span> <span class="o">=</span> <span class="n">newObj</span><span class="o">-&gt;</span><span class="n">getIsa</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cls</span> <span class="o">!=</span> <span class="n">previouslyInitializedClass</span>  <span class="o">&amp;&amp;</span>  
            <span class="o">!</span><span class="p">((</span><span class="n">objc_class</span> <span class="o">*</span><span class="p">)</span><span class="n">cls</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">isInitialized</span><span class="p">())</span> 
        <span class="p">{</span>
            <span class="n">SideTable</span><span class="o">::</span><span class="n">unlockTwo</span><span class="o">&lt;</span><span class="n">haveOld</span><span class="p">,</span> <span class="n">haveNew</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oldTable</span><span class="p">,</span> <span class="n">newTable</span><span class="p">);</span>
            <span class="n">_class_initialize</span><span class="p">(</span><span class="n">_class_getNonMetaClass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">newObj</span><span class="p">));</span>

            <span class="c1">// If this class is finished with +initialize then we're good.
</span>            <span class="c1">// If this class is still running +initialize on this thread 
</span>            <span class="c1">// (i.e. +initialize called storeWeak on an instance of itself)
</span>            <span class="c1">// then we may proceed but it will appear initializing and 
</span>            <span class="c1">// not yet initialized to the check above.
</span>            <span class="c1">// Instead set previouslyInitializedClass to recognize it on retry.
</span>            <span class="n">previouslyInitializedClass</span> <span class="o">=</span> <span class="n">cls</span><span class="p">;</span>

            <span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Clean up old value, if any.
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">haveOld</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">weak_unregister_no_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oldTable</span><span class="o">-&gt;</span><span class="n">weak_table</span><span class="p">,</span> <span class="n">oldObj</span><span class="p">,</span> <span class="n">location</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Assign new value, if any.
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">haveNew</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">newObj</span> <span class="o">=</span> <span class="p">(</span><span class="n">objc_object</span> <span class="o">*</span><span class="p">)</span>
            <span class="n">weak_register_no_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">newTable</span><span class="o">-&gt;</span><span class="n">weak_table</span><span class="p">,</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">newObj</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> 
                                  <span class="n">crashIfDeallocating</span><span class="p">);</span>
        <span class="c1">// weak_register_no_lock returns nil if weak store should be rejected
</span>
        <span class="c1">// Set is-weakly-referenced bit in refcount table.
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">newObj</span>  <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="n">newObj</span><span class="o">-&gt;</span><span class="n">isTaggedPointer</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">newObj</span><span class="o">-&gt;</span><span class="n">setWeaklyReferenced_nolock</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="c1">// Do not set *location anywhere else. That would introduce a race.
</span>        <span class="o">*</span><span class="n">location</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">newObj</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// No new value. The storage is not changed.
</span>    <span class="p">}</span>
    
    <span class="n">SideTable</span><span class="o">::</span><span class="n">unlockTwo</span><span class="o">&lt;</span><span class="n">haveOld</span><span class="p">,</span> <span class="n">haveNew</span><span class="o">&gt;</span><span class="p">(</span><span class="n">oldTable</span><span class="p">,</span> <span class="n">newTable</span><span class="p">);</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">newObj</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>å†…éƒ¨è°ƒç”¨ weak_register_no_lock æ³¨å†Œä¸€ä¸ª weakæŒ‡é’ˆå’Œå¯¹è±¡çš„é”®å€¼å¯¹ï¼Œç„¶åè¿”å›ï¼›å¦‚æœæ³¨å†Œçš„æ—¶å€™å‘ç°è¯¥å¯¹è±¡æ­£åœ¨ dealloc åˆ™ä¼šå´©æºƒï¼Œå¹¶ä¸”é€šè¿‡ _objc_fatal æ–¹æ³•ç•™äº†é—è¨€ï¼ï¼</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="cm">/** 
 * Registers a new (object, weak pointer) pair. Creates a new weak
 * object entry if it does not exist.
 * 
 * @param weak_table The global weak table.
 * @param referent The object pointed to by the weak reference.
 * @param referrer The weak pointer address.
 */</span>
<span class="n">id</span> 
<span class="nf">weak_register_no_lock</span><span class="p">(</span><span class="n">weak_table_t</span> <span class="o">*</span><span class="n">weak_table</span><span class="p">,</span> <span class="n">id</span> <span class="n">referent_id</span><span class="p">,</span> 
                      <span class="n">id</span> <span class="o">*</span><span class="n">referrer_id</span><span class="p">,</span> <span class="n">bool</span> <span class="n">crashIfDeallocating</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">objc_object</span> <span class="o">*</span><span class="n">referent</span> <span class="o">=</span> <span class="p">(</span><span class="n">objc_object</span> <span class="o">*</span><span class="p">)</span><span class="n">referent_id</span><span class="p">;</span>
    <span class="n">objc_object</span> <span class="o">**</span><span class="n">referrer</span> <span class="o">=</span> <span class="p">(</span><span class="n">objc_object</span> <span class="o">**</span><span class="p">)</span><span class="n">referrer_id</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">referent</span>  <span class="o">||</span>  <span class="n">referent</span><span class="o">-&gt;</span><span class="n">isTaggedPointer</span><span class="p">())</span> <span class="k">return</span> <span class="n">referent_id</span><span class="p">;</span>

    <span class="c1">// ensure that the referenced object is viable
</span>    <span class="n">bool</span> <span class="n">deallocating</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">referent</span><span class="o">-&gt;</span><span class="n">ISA</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">hasCustomRR</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">deallocating</span> <span class="o">=</span> <span class="n">referent</span><span class="o">-&gt;</span><span class="n">rootIsDeallocating</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">BOOL</span> <span class="p">(</span><span class="o">*</span><span class="n">allowsWeakReference</span><span class="p">)(</span><span class="n">objc_object</span> <span class="o">*</span><span class="p">,</span> <span class="n">SEL</span><span class="p">)</span> <span class="o">=</span> 
            <span class="p">(</span><span class="n">BOOL</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">objc_object</span> <span class="o">*</span><span class="p">,</span> <span class="n">SEL</span><span class="p">))</span>
            <span class="n">object_getMethodImplementation</span><span class="p">((</span><span class="n">id</span><span class="p">)</span><span class="n">referent</span><span class="p">,</span> 
                                           <span class="n">SEL_allowsWeakReference</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">IMP</span><span class="p">)</span><span class="n">allowsWeakReference</span> <span class="o">==</span> <span class="n">_objc_msgForward</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">deallocating</span> <span class="o">=</span>
            <span class="o">!</span> <span class="p">(</span><span class="o">*</span><span class="n">allowsWeakReference</span><span class="p">)(</span><span class="n">referent</span><span class="p">,</span> <span class="n">SEL_allowsWeakReference</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">deallocating</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">crashIfDeallocating</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_objc_fatal</span><span class="p">(</span><span class="s">"Cannot form weak reference to instance (%p) of "</span>
                        <span class="s">"class %s. It is possible that this object was "</span>
                        <span class="s">"over-released, or is in the process of deallocation."</span><span class="p">,</span>
                        <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">referent</span><span class="p">,</span> <span class="n">object_getClassName</span><span class="p">((</span><span class="n">id</span><span class="p">)</span><span class="n">referent</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// now remember it and where it is being stored
</span>    <span class="n">weak_entry_t</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">entry</span> <span class="o">=</span> <span class="n">weak_entry_for_referent</span><span class="p">(</span><span class="n">weak_table</span><span class="p">,</span> <span class="n">referent</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">append_referrer</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">referrer</span><span class="p">);</span>
    <span class="p">}</span> 
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">weak_entry_t</span> <span class="n">new_entry</span><span class="p">(</span><span class="n">referent</span><span class="p">,</span> <span class="n">referrer</span><span class="p">);</span>
        <span class="n">weak_grow_maybe</span><span class="p">(</span><span class="n">weak_table</span><span class="p">);</span>
        <span class="n">weak_entry_insert</span><span class="p">(</span><span class="n">weak_table</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_entry</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Do not set *referrer. objc_storeWeak() requires that the 
</span>    <span class="c1">// value not change.
</span>
    <span class="k">return</span> <span class="n">referent_id</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>è¿™é‡Œåªèƒ½çŒœæµ‹ runtime æ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°æ˜¯å¦ä¸º 0 æ¥åˆ¤æ–­ä¸€ä¸ªå¯¹è±¡æ˜¯å¦æ˜¯å¤„äº deallocing çŠ¶æ€çš„ï¼Œå› ä¸º SEL_allowsWeakReference è¿™ä¸ªå‡½æ•°çš„å®šä¹‰æ˜¯æ‰¾ä¸åˆ°çš„ï¼ä½†æ˜¯æˆ‘ä»¬ä»æºç ä¸Šå¯ä»¥ç¡®åˆ‡çš„äº†è§£åˆ°ï¼Œå¦‚æœå¯¹è±¡æ­£åœ¨ deallocing ä¸èƒ½è®©ä»–ä½¿ç”¨ weak ä¿®é¥°ï¼å¦è€…å°±å´©æºƒæ‰äº†ï¼ï¼</p>

<div class="highlighter-rouge"><pre class="highlight"><code>if (deallocating) {
    if (crashIfDeallocating) {
        _objc_fatal("Cannot form weak reference to instance (%p) of "
                    "class %s. It is possible that this object was "
                    "over-released, or is in the process of deallocation.",
                    (void*)referent, object_getClassName((id)referent));
    } else {
        return nil;
    }
}
</code></pre>
</div>
<p>objc é‡Œå°è£…äº† _objc_fatal è¿™ä¸ªå‡½æ•°ç”¨äºåœæ­¢ç¨‹åºï¼Œå¹¶ä¸”æä¸ªé—è¨€ï¼Œå†…éƒ¨åˆ™æ˜¯è°ƒç”¨äº† _objc_fatalv</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">_objc_fatal</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
    <span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span> 
    <span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span><span class="n">fmt</span><span class="p">);</span> 
    <span class="n">_objc_fatalv</span><span class="p">(</span><span class="n">OBJC_EXIT_REASON_UNSPECIFIED</span><span class="p">,</span> 
                 <span class="n">OS_REASON_FLAG_ONE_TIME_FAILURE</span><span class="p">,</span> 
                 <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>_objc_fatalv å±äºå†…éƒ¨ç§æœ‰æ–¹æ³•ï¼Œå¯ä»¥æ­£å¸¸ exitï¼Œä¹Ÿå¯ä»¥ abortï¼Œå–å†³äº DebugDontCrash</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">_objc_fatalv</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">reason</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">buf1</span><span class="p">;</span>
    <span class="n">vasprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf1</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">buf2</span><span class="p">;</span>
    <span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf2</span><span class="p">,</span> <span class="s">"objc[%d]: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span> <span class="n">buf1</span><span class="p">);</span>
    <span class="n">_objc_syslog</span><span class="p">(</span><span class="n">buf2</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">DebugDontCrash</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">buf3</span><span class="p">;</span>
        <span class="n">asprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf3</span><span class="p">,</span> <span class="s">"objc[%d]: HALTED</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
        <span class="n">_objc_syslog</span><span class="p">(</span><span class="n">buf3</span><span class="p">);</span>
        <span class="n">_Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="n">abort_with_reason</span><span class="p">(</span><span class="n">OS_REASON_OBJC</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">buf1</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>ä¸Šé¢çš„æµç¨‹å¤§è‡´æ˜¯å°† weak æè¿°çš„å˜é‡å­˜èµ·æ¥çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å†æŒ–æ˜ä¸‹å¯¹è±¡é‡Šæ”¾åï¼Œweak å˜é‡è‡ªåŠ¨ç½®ç©ºçš„é€»è¾‘:</p>

<h2 id="dealloc-æ—¶æ¸…ç†æ‰-weak-å˜é‡">dealloc æ—¶æ¸…ç†æ‰ weak å˜é‡</h2>

<p>æ—¢ç„¶æˆ‘ä»¬çŸ¥é“äº†ç»“è®ºï¼Œé‚£ä¹ˆå°±ç›´æ¥ä» dealloc å¼€å§‹çœ‹æ–¹æ³•è°ƒç”¨å§:</p>

<div class="language-objc highlighter-rouge"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">dealloc</span> <span class="p">{</span>
    <span class="n">_objc_rootDealloc</span><span class="p">(</span><span class="n">self</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">_objc_rootDealloc</span><span class="p">(</span><span class="n">id</span> <span class="n">obj</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>

    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">rootDealloc</span><span class="p">();</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">void</span> <span class="n">objc_object</span><span class="o">::</span><span class="n">rootDealloc</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isTaggedPointer</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">object_dispose</span><span class="p">((</span><span class="n">id</span><span class="p">)</span><span class="n">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">id</span> <span class="n">object_dispose</span><span class="p">(</span><span class="n">id</span> <span class="n">obj</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">_dealloc</span><span class="p">)(</span><span class="n">obj</span><span class="p">);</span> 
<span class="p">}</span>

<span class="c1">///æ³¨æ„ _dealloc å…¶å®å°±æ˜¯ _object_dispose
</span><span class="n">id</span> <span class="p">(</span><span class="o">*</span><span class="n">_dealloc</span><span class="p">)(</span><span class="n">id</span><span class="p">)</span> <span class="o">=</span> <span class="n">_object_dispose</span><span class="p">;</span>

<span class="k">static</span> <span class="n">id</span> <span class="nf">_object_dispose</span><span class="p">(</span><span class="n">id</span> <span class="n">anObject</span><span class="p">)</span> 
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">anObject</span><span class="o">==</span><span class="nb">nil</span><span class="p">)</span> <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>

    <span class="n">objc_destructInstance</span><span class="p">(</span><span class="n">anObject</span><span class="p">);</span>
    
    <span class="n">anObject</span><span class="o">-&gt;</span><span class="n">initIsa</span><span class="p">(</span><span class="n">_objc_getFreedObjectClass</span> <span class="p">());</span> 

    <span class="n">free</span><span class="p">(</span><span class="n">anObject</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>çœ‹æ³¨é‡Šå¯ä»¥çŸ¥é“ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å¹²æ¸…ç†çš„å·¥ä½œçš„ï¼Œä¸é‡Šæ”¾å¯¹è±¡çš„å†…å­˜ï¼›å…·ä½“æ˜¯æ¸…ç†å…³è”åº”ç”¨çš„å¯¹è±¡å’Œå­˜å‚¨çš„ weak æŒ‡é’ˆ :</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/***********************************************************************
* objc_destructInstance
* Destroys an instance without freeing memory. 
* Calls C++ destructors.
* Removes associative references.
* Returns `obj`. Does nothing if `obj` is nil.
* CoreFoundation and other clients do call this under GC.
**********************************************************************/

void *objc_destructInstance(id obj) 
{
    if (obj) {
        Class isa = obj-&gt;getIsa();

        if (isa-&gt;hasCxxDtor()) {
            object_cxxDestruct(obj);
        }
		 ///ä¹‹å‰çœ‹å…³è”å¼•ç”¨çš„æ—¶å€™ï¼Œå·²ç»çœ‹è¿‡è¿™ä¸ªæ–¹æ³•
        if (isa-&gt;instancesHaveAssociatedObjects()) {
            _object_remove_assocations(obj);
        }
		 ///ä»Šå¤©æ¥çœ‹ä¸‹æ¸…ç† weak æŒ‡é’ˆçš„æ–¹æ³•å§
        objc_clear_deallocating(obj);
    }

    return obj;
}

void objc_clear_deallocating(id obj) 
{
    assert(obj);

    if (obj-&gt;isTaggedPointer()) return;
    obj-&gt;clearDeallocating();
}


inline void objc_object::clearDeallocating()
{
    sidetable_clearDeallocating();
}

void objc_object::sidetable_clearDeallocating()
{
    SideTable&amp; table = SideTables()[this];

    // clear any weak table items
    // clear extra retain count and deallocating bit
    // (fixme warn or abort if extra retain count == 0 ?)
    table.lock();
    RefcountMap::iterator it = table.refcnts.find(this);
    if (it != table.refcnts.end()) {
        if (it-&gt;second &amp; SIDE_TABLE_WEAKLY_REFERENCED) {
            weak_clear_no_lock(&amp;table.weak_table, (id)this);
        }
        table.refcnts.erase(it);
    }
    table.unlock();
}

/** 
 * Called by dealloc; nils out all weak pointers that point to the 
 * provided object so that they can no longer be used.
 * 
 * @param weak_table 
 * @param referent The object being deallocated. 
 */
void 
weak_clear_no_lock(weak_table_t *weak_table, id referent_id) 
{
    objc_object *referent = (objc_object *)referent_id;

    weak_entry_t *entry = weak_entry_for_referent(weak_table, referent);
    if (entry == nil) {
        /// XXX shouldn't happen, but does with mismatched CF/objc
        //printf("XXX no entry for clear deallocating %p\n", referent);
        return;
    }

    // zero out references
    weak_referrer_t *referrers;
    size_t count;
    
    if (entry-&gt;out_of_line()) {
        referrers = entry-&gt;referrers;
        count = TABLE_SIZE(entry);
    } 
    else {
        referrers = entry-&gt;inline_referrers;
        count = WEAK_INLINE_COUNT;
    }
    
    for (size_t i = 0; i &lt; count; ++i) {
        objc_object **referrer = referrers[i];
        if (referrer) {
            if (*referrer == referent) {
                *referrer = nil;
            }
            else if (*referrer) {
                _objc_inform("__weak variable at %p holds %p instead of %p. "
                             "This is probably incorrect use of "
                             "objc_storeWeak() and objc_loadWeak(). "
                             "Break on objc_weak_error to debug.\n", 
                             referrer, (void*)*referrer, (void*)referent);
                objc_weak_error();
            }
        }
    }
    
    weak_entry_remove(weak_table, entry);
}
</code></pre>
</div>

<p>æ‰¾äº†åŠå¤©ï¼Œæˆ‘ä»¬æƒ³çœ‹åˆ°çš„ä»£ç æ— éæ˜¯åœ¨deallocé‡Œæ‰§è¡Œç½®ç©ºå’Œä»tableé‡Œç§»é™¤ï¼š</p>

<div class="highlighter-rouge"><pre class="highlight"><code>if (*referrer == referent) {
    *referrer = nil;
}
weak_entry_remove(weak_table, entry);

</code></pre>
</div>

<p>æˆªæ­¢åˆ°ä»Šæ—¥ï¼Œäº†è§£äº†å¯¹è±¡ dealloc æ—¶ç³»ç»Ÿæ¡†æ¶åˆ°åº•åšäº†ä»€ä¹ˆï¼Œæ¸…æ¥šçš„çŸ¥é“äº†å…³è”å¼•ç”¨å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œ weak å˜é‡ç½®ç©ºçš„åŸç†ï¼Œå¯¹äºæ—¥åä¿®æ”¹ä¸€äº›é—®é¢˜ï¼Œå®ç°æŸäº›ç‰¹æ€§çš„é€»è¾‘(ç½‘ç»œåº“é‡Œçš„è‡ªåŠ¨å–æ¶ˆå°±æ˜¯é€šè¿‡å…³è”å¼•ç”¨åšçš„ï¼Œåˆ©ç”¨äº†å¯¹è±¡é‡Šæ”¾æ—¶ï¼Œè‡ªåŠ¨é‡Šæ”¾å…³è”å¯¹è±¡è¿™ä¸€ç‰¹æ€§)ï¼Œå°±æ›´åŠ æœ‰æŠŠæ¡äº†ï¼</p>

<p>æ³¨ï¼šobjc çš„æºç æ˜¯ä¸€ç›´åœ¨æ›´æ–°çš„ï¼Œå¦‚æœä½ çœ‹çš„ä¸æ˜¯ objc4-709.tar.gz è¿™ä¸ªåŒ…çš„è¯ï¼Œå¯èƒ½æºç ä¸æˆ‘è´´çš„æœ‰å·®å¼‚ï¼</p>

  </div>

  <div class="modify">
  	æœ€åä¸€æ¬¡ä¿®æ”¹æ—¶é—´ : 17å¹´08æœˆ02æ—¥.
  </div>

</div>

<div class="nav-meta">
	
	<a class="previous" href="/ios/2017/07/17/weakself-in-dealloc-cause-crash/"> << åœ¨ dealloc é‡Œä½¿ç”¨ weak self å¼•èµ·å´©æºƒï¼Ÿ </a>
	

	
	<a class="next" href="/ios/cocoapods/2017/07/19/install-cocoapods/"> å®‰è£… CocoaPods >> </a>
	
</div>

<div class="post-zan">
			<a href="alipays://platformapi/startapp?saId=10000007&clientVersion=3.7.0.0718&qrcode=https%3A%2F%2Fqr.alipay.com%2FFKX0851484LFW1ZXQOUM37%3F_s%3Dweb-other">ğŸ‘ æ–‡ç« å¯¹æˆ‘æœ‰å¸®åŠ©ï¼Œæ‰“èµ1å…ƒ ğŸ‘</a>
</div>

<!-- <div class="related">
    
    <h2>ã€Š<a class="meta-category" href="/categories/iOS/index.html">iOS</a>ã€‹Related Posts</h2>
    <ul class="related-posts">
      
        
          <li>
            <h3>
              <a href="/ios/cocoapods/2017/07/21/use-cocoapods-manager-frameworks/">
                ä½¿ç”¨ CocoaPods ç®¡ç† frameworks
                <small>21 Jul 2017</small>
              </a>
            </h3>
          </li>
        
      
        
          <li>
            <h3>
              <a href="/ios/cocoapods/2017/07/20/create-pod-library/">
                åˆ›å»º CocoaPods åº“
                <small>20 Jul 2017</small>
              </a>
            </h3>
          </li>
        
      
        
          <li>
            <h3>
              <a href="/ios/cocoapods/2017/07/19/install-cocoapods/">
                å®‰è£… CocoaPods
                <small>19 Jul 2017</small>
              </a>
            </h3>
          </li>
        
      
        
      
        
          <li>
            <h3>
              <a href="/ios/2017/07/17/weakself-in-dealloc-cause-crash/">
                åœ¨ dealloc é‡Œä½¿ç”¨ weak self å¼•èµ·å´©æºƒï¼Ÿ
                <small>17 Jul 2017</small>
              </a>
            </h3>
          </li>
        
      
      </ul>
    
</div> -->

<div class="related">
  <h2> ç›¸å…³æ–‡ç«  </h2>
  <ol class="related-posts">
    
      
        <li>
          <h3>
            <a href="/ios/cocoapods/2017/07/21/use-cocoapods-manager-frameworks/">
              ä½¿ç”¨ CocoaPods ç®¡ç† frameworks
              <small>21 Jul 2017</small>
            </a>
          </h3>
        </li>
      
    
      
        <li>
          <h3>
            <a href="/ios/cocoapods/2017/07/20/create-pod-library/">
              åˆ›å»º CocoaPods åº“
              <small>20 Jul 2017</small>
            </a>
          </h3>
        </li>
      
    
      
        <li>
          <h3>
            <a href="/ios/cocoapods/2017/07/19/install-cocoapods/">
              å®‰è£… CocoaPods
              <small>19 Jul 2017</small>
            </a>
          </h3>
        </li>
      
    
      
        <li>
          <h3>
            <a href="/ios/2017/07/17/weakself-in-dealloc-cause-crash/">
              åœ¨ dealloc é‡Œä½¿ç”¨ weak self å¼•èµ·å´©æºƒï¼Ÿ
              <small>17 Jul 2017</small>
            </a>
          </h3>
        </li>
      
    
      
        <li>
          <h3>
            <a href="/ios/2015/07/14/jie-jue-nstimeryin-qi-de-nei-cun-xie-lou/">
              è§£å†³ NSTimer å†…å­˜æ³„æ¼é—®é¢˜
              <small>14 Jul 2015</small>
            </a>
          </h3>
        </li>
      
    
      
        <li>
          <h3>
            <a href="/script/2015/07/07/bo-ke-an-jia-la/">
              Hello My Blog
              <small>07 Jul 2015</small>
            </a>
          </h3>
        </li>
      
    
      
        <li>
          <h3>
            <a href="/2014/01/02/introducing-lanyon/">
              Introducing Lanyon
              <small>02 Jan 2014</small>
            </a>
          </h3>
        </li>
      
    
      
        <li>
          <h3>
            <a href="/2014/01/01/example-content/">
              Example content
              <small>01 Jan 2014</small>
            </a>
          </h3>
        </li>
      
    
  </ol>
</div>

<!-- è¯„è®º -->
<div class="comment">
  <h2> è¯„è®º </h2>
	<div class="comment-body">
		<div id="SOHUCS" sid=/ios/2017/07/18/objc-weak-obj-imp></div>
<script charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/changyan.js" ></script>
<script type="text/javascript">
window.changyan.api.config({
appid: 'cysIuT5kR',
conf: 'prod_fd7df0395aed8f2cdaa12c462f602912'
});
</script>

	</div>
</div>

<script>
function is_mobile_browser() {
    var sUserAgent = navigator.userAgent.toLowerCase();
    var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
    var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";
    var bIsMidp = sUserAgent.match(/midp/i) == "midp";
    var bIsUc7 = sUserAgent.match(/rv:1.2.3.4/i) == "rv:1.2.3.4";
    var bIsUc = sUserAgent.match(/ucweb/i) == "ucweb";
    var bIsAndroid = sUserAgent.match(/android/i) == "android";
    var bIsCE = sUserAgent.match(/windows ce/i) == "windows ce";
    var bIsWM = sUserAgent.match(/windows mobile/i) == "windows mobile";

    if (bIsIpad || bIsIphoneOs || bIsMidp || bIsUc7 || bIsUc || bIsAndroid || bIsCE || bIsWM) {
        var e = document.getElementById('post-zan');
        e.style.display="block";
    }
}

is_mobile_browser();
</script>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <div class="common-footer">
	<span>
		Copyright Â© <a href="https://github.com/debugly" target="_blank">Debugly </a>2017.
		Build with <a href="https://jekyllrb.com" target="_blank">Jekyll</a>.
		Hosted on <a href="https://pages.github.com/" target="_blank">GitHub</a>.
	</span>
</div>

    
    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
